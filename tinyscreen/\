#include <Wire.h>
#include <SPI.h>
#include <TinyScreen.h>
#include <WiFi101.h>
#include <string.h>

#include "wifi_handler.h"

typedef enum {
  NO_WIFI,
  FINDING_SERVER,
  CONNECTED_TO_SERVER
} State;

WiFiUDP udp;
char received_packet[2048];
int debug = 0;
State state;
GameState* game_state;

TinyScreen display = TinyScreen(TinyScreenPlus);
IPAddress remote_ip = IPAddress(69, 69, 69, 69); // quote unquote sentinel

void setup() {
    Wire.begin();
    SerialUSB.begin(9600);
    while (!SerialUSB);
    WiFi.setPins(8, 2, A3, -1); // necessary for whatever reason
    display.begin();
    display.setBrightness(10);
    display.clearScreen();
    display.setFont(thinPixel7_10ptFontInfo);
    display.setCursor(0, 0);
    state = NO_WIFI;
    GameState* game_state = (GameState*)malloc(sizeof(GameState));
    delay(2000);
}

void loop() {
  if (state == NO_WIFI) {
    if (prompt_and_connect(display))  {
      state = FINDING_SERVER;
      udp.begin(1000);
    }
    return;
  }

  int packet_size = udp.parsePacket();
  if (packet_size) {
    int read_amt = (packet_size > 2048) ? 2048 : packet_size;
    int len = udp.read(received_packet, packet_size);
    if (debug) {
      serialf("\nreceived packet from %d:%d\n",
          ip_to_str(udp.remoteIP()),
          udp.remotePort()
      );
      hexdump(received_packet, packet_size);
    }
  }

  switch (state) {
    case FINDING_SERVER:
      broadcast_packet(udp);
      serialf("current packet > %s\n", received_packet);
      remote_ip = receive_discover(udp, received_packet);
      if (remote_ip != IPAddress(69, 69, 69, 69)) {
        join_server(udp, remote_ip);
        state = CONNECTED_TO_SERVER;
      }
      break;

    case CONNECTED_TO_SERVER:
      // do stuff here with the packet
      debug = 1;
      break;
  }
}

